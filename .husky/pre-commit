# VRP Enforcement - Zero tolerance for violations
echo "ğŸ” VRP Pre-Commit Checks..."

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ›¡ï¸ WCCC PROTECTION - Block page-specific CSS files
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if git diff --cached --name-only | grep -E 'src/app/.*/page\.css$'; then
  echo ""
  echo "â›” WCCC VIOLATION: page.css files are not allowed!"
  echo ""
  echo "Page-specific CSS files violate the 5-hub architecture."
  echo ""
  echo "Allowed CSS hubs:"
  echo "  â€¢ /styles/prebuilts.css (vr-* components)"
  echo "  â€¢ /styles/features.css (ft-* components)"
  echo "  â€¢ /styles/layout.css (ly-* shell + layouts)"
  echo ""
  echo "If you need custom styling:"
  echo "  1. Check if a prebuilt variant exists"
  echo "  2. Create new prebuilt variant in /src/prebuilts/"
  echo "  3. Last resort: Create feature component in /src/features/"
  echo ""
  echo "See TTT-WCCC-PROTOCOL.md for architectural rationale."
  echo ""
  echo "Commit blocked."
  exit 1
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”’ SACRED CONFIG PROTECTION - Approval Bridge for ESLint changes
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if git diff --cached --name-only | grep -q "^eslint.config.mjs$"; then
  # Check for approval token
  if [ -f ".vrp-approval" ]; then
    echo "âœ… Approval token found - ESLint change authorized"
    rm -f .vrp-approval  # Consume token (single-use)
    echo "ğŸ”¥ Token consumed (single-use)"
  else
    echo ""
    echo "â›” CRITICAL: eslint.config.mjs modification detected!"
    echo ""
    echo "This file contains the VIRGIN EXCEPTION LIST."
    echo "Changes to ESLint rules or exceptions require explicit approval."
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  ğŸš« NO VERIFY CANCER WARNING"
    echo "  Using --no-verify is FORBIDDEN in this repository."
    echo "  It bypasses ALL protections and corrupts the VRP."
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "APPROVED WORKFLOW:"
    echo "  1. Claude Code asks user for approval"
    echo "  2. User approves the specific change"
    echo "  3. Claude creates .vrp-approval token"
    echo "  4. Commit proceeds with token (token is consumed)"
    echo ""
    echo "If you are manually editing, create .vrp-approval file first."
    echo ""
    echo "Commit blocked. Approval token required."
    exit 1
  fi
fi

# Run critical VRP scripts (manifest validation skipped - legacy routes not yet in SMAC manifests)
npm run vrp:isv || exit 1
npm run vrp:naming || exit 1

# Run lint-staged for TypeScript/ESLint checks
npx lint-staged
