# VRP Enforcement - Zero tolerance for violations
echo "ğŸ” VRP Pre-Commit Checks..."

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ›¡ï¸ WCCC PROTECTION - Block page-specific CSS files
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if git diff --cached --name-only | grep -E 'src/app/.*/page\.css$'; then
  echo ""
  echo "â›” WCCC VIOLATION: page.css files are not allowed!"
  echo ""
  echo "Page-specific CSS files violate the 5-hub architecture."
  echo ""
  echo "Allowed CSS hubs:"
  echo "  â€¢ /styles/prebuilts.css (vr-* components)"
  echo "  â€¢ /styles/features.css (ft-* components)"
  echo "  â€¢ /styles/layout.css (ly-* shell + layouts)"
  echo ""
  echo "If you need custom styling:"
  echo "  1. Check if a prebuilt variant exists"
  echo "  2. Create new prebuilt variant in /src/prebuilts/"
  echo "  3. Last resort: Create feature component in /src/features/"
  echo ""
  echo "See TTT-WCCC-PROTOCOL.md for architectural rationale."
  echo ""
  echo "Commit blocked."
  exit 1
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”’ SACRED CONFIG PROTECTION - Approval Bridge for protected files
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Protected files: eslint.config.mjs, .stylelintrc.json, package.json, .husky/*
PROTECTED_FILES="eslint.config.mjs|\.stylelintrc\.json|package\.json|\.husky/"

if git diff --cached --name-only | grep -qE "^($PROTECTED_FILES)"; then
  # Get the specific file(s) being modified
  MODIFIED_PROTECTED=$(git diff --cached --name-only | grep -E "^($PROTECTED_FILES)")

  # Check for approval token
  if [ -f ".vrp-approval" ]; then
    echo "âœ… Approval token found - Protected file change authorized"
    echo "   Files: $MODIFIED_PROTECTED"
    rm -f .vrp-approval  # Consume token (single-use)
    echo "ğŸ”¥ Token consumed (single-use)"
  else
    echo ""
    echo "â›” CRITICAL: Protected file modification detected!"
    echo ""
    echo "Modified: $MODIFIED_PROTECTED"
    echo ""
    echo "These files control the VRP protection system."
    echo "Changes require explicit approval."
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  ğŸš« NO VERIFY CANCER WARNING"
    echo "  Using --no-verify is FORBIDDEN in this repository."
    echo "  It bypasses ALL protections and corrupts the VRP."
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "APPROVED WORKFLOW:"
    echo "  1. Claude Code asks user for approval"
    echo "  2. User approves the specific change"
    echo "  3. Claude creates .vrp-approval token"
    echo "  4. Commit proceeds with token (token is consumed)"
    echo ""
    echo "If you are manually editing, create .vrp-approval file first."
    echo ""
    echo "Commit blocked. Approval token required."
    exit 1
  fi
fi

# Run critical VRP scripts (manifest validation skipped - legacy routes not yet in SMAC manifests)
npm run vrp:isv || exit 1
npm run vrp:naming || exit 1

# Run lint-staged for TypeScript/ESLint checks
npx lint-staged
